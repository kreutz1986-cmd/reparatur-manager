<!-- VERSION FÃœR LIVE-BETRIEB -->
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reparatur Manager Online v1.60</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
  <!-- PDF Export Bibliotheken -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <style>
      body { font-family: 'Inter', sans-serif; }
      [v-cloak] { display: none; }

      .modal-backdrop { position: fixed; inset: 0; display: flex; justify-content: center; align-items: center; background-color: rgba(0,0,0,.5); z-index: 50; padding: 1rem; }
      .modal-content { background: #fff; padding: 2rem; border-radius: .5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05); width: 90%; max-width: 768px; max-height: 90vh; overflow-y: auto; }
      .table-row-selected { background-color: #eef2ff; }
      .table-row-urgent { background-color: #fee2e2; }

      .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4f46e5; animation: spin 1s ease infinite; }
      
      .toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 100; display: flex; flex-direction: column; gap: 0.75rem; }
      .toast { display: flex; align-items: center; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -1px rgba(0,0,0,.06); transform: translateX(100%); opacity: 0; transition: all 0.3s ease-in-out; }
      .toast.show { transform: translateX(0); opacity: 1; }
      .toast-info { background-color: #3b82f6; color: white; }
      .toast-success { background-color: #22c55e; color: white; }
      .toast-error { background-color: #ef4444; color: white; }

      .fallout-loader { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background-color: #0d1a26; font-family: 'Roboto Mono', monospace; overflow: hidden; }
      .vault-logo { width: 200px; height: 200px; border-radius: 50%; background: radial-gradient(circle, #003c5a 0%, #00283c 100%); border: 10px solid #005a87; display: flex; justify-content: center; align-items: center; box-shadow: 0 0 30px rgba(0, 191, 255, 0.5), inset 0 0 20px rgba(0,0,0,0.7); position: relative; }
      .vault-gear { width: 180px; height: 180px; position: absolute; background-image: radial-gradient(circle, transparent 60%, #0077b3 61%, #0077b3 65%, transparent 66%), repeating-conic-gradient(#0077b3 0% 5%, transparent 5% 10%); -webkit-mask-image: radial-gradient(circle, transparent 60%, black 61%); mask-image: radial-gradient(circle, transparent 60%, black 61%); animation: spin 10s linear infinite; }
      .vault-number { font-size: 4rem; font-weight: 700; color: #ffc107; text-shadow: 0 0 10px #ffc107, 0 0 20px #ff8f00; z-index: 10; }
      .loading-text { margin-top: 2rem; color: #00bfff; font-size: 1.125rem; letter-spacing: 0.2em; text-shadow: 0 0 5px #00bfff, 0 0 10px #00bfff; animation: blink 1.5s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      @keyframes blink { 50% { opacity: 0.5; } }
      th { cursor: pointer; user-select: none; }
      th .sort-icon { opacity: 0.3; }
      th.active .sort-icon { opacity: 1; }
      .system-comment { font-style: italic; color: #4b5563; }
      td mark { background-color: #fef08a; padding: 1px; border-radius: 2px; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div id="fatal" style="display:none;background:#fee2e2;color:#7f1d1d;padding:12px 16px;font-family:Inter,system-ui,Arial">
  <strong>Fehler:</strong> <span id="fatal-msg">Unbekannter Fehler.</span>
</div>

<div id="app" v-cloak>

  <!-- Ladeanzeige -->
  <div v-if="!isAuthReady" class="fallout-loader">
    <div class="vault-logo">
        <div class="vault-gear"></div>
        <div class="vault-number">SK</div>
    </div>
    <p class="loading-text">SYSTEM WIRD GESTARTET...</p>
  </div>

  <!-- Login -->
  <div v-if="isAuthReady && !user.loggedIn" class="min-h-screen flex items-center justify-center bg-gray-50 py-8 px-4">
    <div class="max-w-md w-full space-y-8">
      <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">{{ t.mainTitle }}</h2>
      <form class="mt-8 space-y-6" @submit.prevent="login">
        <div class="rounded-md shadow-sm -space-y-px">
          <input v-model="loginForm.email" type="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" :placeholder="t.emailPlaceholder">
          <input v-model="loginForm.password" type="password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" :placeholder="t.passwordPlaceholder">
        </div>
        <p v-if="loginForm.error" class="text-red-500 text-sm">{{ loginForm.error }}</p>
        <button type="submit" class="w-full py-2 px-4 text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">{{ t.loginButton }}</button>
      </form>
    </div>
  </div>


  <!-- Main App -->
  <div v-if="isAuthReady && user.loggedIn" class="p-4 md:p-8">
    <header class="flex flex-wrap justify-between items-center mb-6 border-b pb-4">
      <div class="flex items-center space-x-6">
        <h1 class="text-2xl font-bold text-gray-700">{{ t.mainTitle }} <span class="text-sm font-light text-gray-500">v{{ version }}</span></h1>
        <nav class="flex items-center space-x-4">
          <button @click="currentView = 'repairs'" :class="{'bg-indigo-100 text-indigo-700': currentView === 'repairs', 'text-gray-500 hover:bg-gray-100': currentView !== 'repairs'}" class="px-3 py-2 rounded-md text-sm font-medium">{{ t.repairs }}</button>
          <button v-if="user.technicianName" @click="currentView = 'my_repairs'" :class="{'bg-indigo-100 text-indigo-700': currentView === 'my_repairs', 'text-gray-500 hover:bg-gray-100': currentView !== 'my_repairs'}" class="px-3 py-2 rounded-md text-sm font-medium">{{ t.myRepairs }}</button>
          <button @click="currentView = 'dashboard'" :class="{'bg-indigo-100 text-indigo-700': currentView === 'dashboard', 'text-gray-500 hover:bg-gray-100': currentView !== 'dashboard'}" class="px-3 py-2 rounded-md text-sm font-medium">{{ t.dashboard }}</button>
        </nav>
      </div>
      <div class="flex items-center mt-4 sm:mt-0 space-x-4">
        <div v-if="!isOnline" class="flex items-center space-x-2 bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full text-sm font-semibold">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636a9 9 0 010 12.728m-12.728 0a9 9 0 010-12.728m12.728 0L5.636 18.364m12.728 0L5.636 5.636"></path></svg>
            <span>Offline</span>
        </div>
        <div class="flex items-center space-x-1 border border-gray-300 rounded-md p-0.5">
            <button @click="setLanguage('de')" :class="{'bg-indigo-600 text-white': currentLanguage === 'de', 'bg-white text-gray-600': currentLanguage !== 'de'}" class="px-3 py-1 rounded-md text-sm font-bold">DE</button>
            <button @click="setLanguage('fr')" :class="{'bg-indigo-600 text-white': currentLanguage === 'fr', 'bg-white text-gray-600': currentLanguage !== 'fr'}" class="px-3 py-1 rounded-md text-sm font-bold">FR</button>
        </div>
        <button @click="showHouseManagement = true" class="bg-white hover:bg-gray-100 text-gray-700 font-semibold py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm">{{ t.manageHouses }}</button>
        <button @click="toggleFullscreen" class="p-2 rounded-md hover:bg-gray-200" :title="isFullscreen ? t.exitFullscreen : t.enterFullscreen">
            <svg v-if="!isFullscreen" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 0h-4m4 0l-5-5" />
            </svg>
            <svg v-else xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 4H4v6m0 8v-6h6m10-2h-6V4m0 8h6v6" />
            </svg>
        </button>
        <div class="relative" v-if="user.isAdmin">
          <button @click="showAdminMenu = !showAdminMenu" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md text-sm flex items-center">
            {{ t.administration }}
            <svg class="ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
          </button>
          <div v-if="showAdminMenu" @click.away="showAdminMenu = false" class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 z-20">
            <a href="#" @click.prevent="showUserManagement = true; showAdminMenu = false" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">{{ t.users }}</a>
            <a href="#" @click.prevent="showTechnikerManagement = true; showAdminMenu = false" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">{{ t.technicians }}</a>
            <a href="#" @click.prevent="showFehlerManagement = true; showAdminMenu = false" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">{{ t.manageErrors }}</a>
            <a href="#" @click.prevent="showQrCodeManagement = true; showAdminMenu = false" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">{{ t.manageQrCodes }}</a>
          </div>
        </div>
        <span class="text-sm text-gray-600">
          {{ t.loggedInAs }}: {{ user.email }}
          <span v-if="user.isAdmin" class="font-semibold text-indigo-600">(Admin)</span>
        </span>
        <button @click="logout" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md text-sm">{{ t.logoutButton }}</button>
      </div>
    </header>

    <!-- Reparaturen & Meine Reparaturen View -->
    <div v-if="currentView === 'repairs' || currentView === 'my_repairs'">
      <!-- New Entry -->
      <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h2 class="text-xl font-semibold mb-4 border-b pb-2">{{ t.newRepairEntry }}</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">{{ t.houseLabel }}</label>
            <select v-model="newEntry.house" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
              <option v-for="house in houses" :key="house" :value="house">{{ house }}</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">{{ t.capturedAtLabel }}</label>
            <input v-model="newEntry.captured_at" type="date" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">{{ t.dateLabel }}</label>
            <input v-model="newEntry.date" type="text" placeholder="z.B. 23W25" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">{{ t.deviceLabel }}</label>
            <input v-model="newEntry.fiche" type="text" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">{{ t.engagementLabel }}</label>
            <input v-model="newEntry.fiche_engagement" type="text" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">{{ t.ipeiLabel }}</label>
             <div class="relative mt-1">
                <input v-model.trim="newEntry.ipei" type="text" class="block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm pr-20">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                    <div v-if="isCheckingIpei" class="spinner h-5 w-5 border-2"></div>
                    <span v-else-if="ipeiHistoryCount > 0" class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800" :title="t.ipeiHistoryTooltip(ipeiHistoryCount)">
                        {{ ipeiHistoryCount }}x {{ t.ipeiHistoryFound }}
                    </span>
                </div>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">{{ t.pidLabel }}</label>
            <input v-model="newEntry.pid" type="text" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">{{ t.errorLabel }}</label>
            <input v-model="newEntry.error" list="common-errors" type="text" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            <datalist id="common-errors">
                <option v-for="error in commonErrors" :key="error" :value="error"></option>
            </datalist>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">{{ t.statusLabel }}</label>
            <select v-model="newEntry.status" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
              <option>{{ t.statusOpen }}</option><option>{{ t.statusInProgress }}</option><option>{{ t.statusCompleted }}</option><option>{{ t.statusCompletedAtCustomer }}</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">{{ t.assignTechnicianLabel }}</label>
            <select v-model="newEntry.techniker" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
              <option value="">{{ t.noOne }}</option><option v-for="techniker in technikerList" :key="techniker" :value="techniker">{{ techniker }}</option>
            </select>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700">{{ t.qrCodeLabel }}</label>
            <div class="mt-1 flex rounded-md shadow-sm">
              <input v-model="qrCodeInput" @keydown="handleQrKeyDown" type="text" class="flex-1 block w-full rounded-md py-2 px-3 border border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" :placeholder="t.scanPlaceholder">
            </div>
          </div>
          <div class="col-span-1 md:col-span-2 lg:col-span-4 flex items-end">
            <button @click="addRepair" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">{{ t.addButton }}</button>
          </div>
        </div>
      </div>

      <!-- Controls & Table -->
      <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
          <!-- Filter Sektion -->
          <div class="flex flex-wrap items-end gap-4">
            <div v-if="currentView !== 'my_repairs'">
              <label class="text-sm font-medium text-gray-700">{{ t.houseFilterLabel }}</label>
              <select v-model="filter.house" class="mt-1 inline-block py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <option value="">{{ t.all }}</option><option v-for="house in houses" :key="house" :value="house">{{ house }}</option>
              </select>
            </div>
            <div v-if="currentView !== 'my_repairs'">
              <label class="text-sm font-medium text-gray-700">{{ t.technicianFilterLabel }}</label>
              <select v-model="filter.technician" class="mt-1 inline-block py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <option value="">{{ t.all }}</option><option v-for="tech in technikerList" :key="tech" :value="tech">{{ tech }}</option>
              </select>
            </div>
             <div>
              <label class="text-sm font-medium text-gray-700">{{ t.statusFilterLabel }}</label>
              <select v-model="filter.status" class="mt-1 inline-block py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <option value="">{{ t.all }}</option>
                <option>{{ t.statusOpen }}</option><option>{{ t.statusInProgress }}</option><option>{{ t.statusCompleted }}</option><option>{{ t.statusCompletedAtCustomer }}</option>
              </select>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-700">{{ t.searchLabel }}</label>
              <input v-model="filter.search" type="text" :placeholder="t.searchPlaceholder" class="mt-1 inline-block w-full sm:w-64 py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            </div>
          </div>
          <div>
            <button @click="exportCSV" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md text-sm">Export CSV</button>
          </div>
        </div>
        
        <!-- Massenbearbeitung -->
        <div v-if="selectedRepairs.length > 0" class="bg-indigo-50 border border-indigo-200 rounded-md p-4 mb-4 flex flex-wrap items-center gap-4">
            <p class="text-sm font-semibold text-indigo-800">{{ selectedRepairs.length }} {{ t.bulkEditSelected }}</p>
            <div class="flex-grow flex flex-wrap items-end gap-x-4 gap-y-2">
                <div class="flex-grow">
                    <label class="block text-sm font-medium text-gray-700">{{ t.bulkEditAssignTechnician }}</label>
                    <select v-model="bulkEdit.technician" class="mt-1 w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                      <option value="">{{ t.noChange }}</option><option value="NONE">{{ t.noOne }}</option><option v-for="tech in technikerList" :key="tech" :value="tech">{{ tech }}</option>
                    </select>
                </div>
                 <div class="flex-grow">
                    <label class="block text-sm font-medium text-gray-700">{{ t.bulkEditChangeStatus }}</label>
                    <select v-model="bulkEdit.status" class="mt-1 w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                      <option value="">{{ t.noChange }}</option>
                      <option>{{ t.statusOpen }}</option><option>{{ t.statusInProgress }}</option><option>{{ t.statusCompleted }}</option><option>{{ t.statusCompletedAtCustomer }}</option>
                    </select>
                </div>
                <button @click="applyBulkEdit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">{{ t.bulkEditApplyButton }}</button>
                <button @click="generateEmail" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-md">{{ t.generateEmailButton }}</button>
            </div>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3"><input type="checkbox" @change="toggleSelectAll" :checked="allSelected" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"></th>
                <th v-for="(header, key) in tableHeaders" :key="key" @click="sortBy(key)" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" :class="{ 'active': sortKey === key }">
                  <div class="flex items-center">
                    <span>{{ header }}</span>
                    <span class="ml-2 sort-icon">
                      <svg v-if="sortKey === key && sortOrder === 'asc'" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>
                      <svg v-else-if="sortKey === key && sortOrder === 'desc'" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                      <svg v-else class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4" /></svg>
                    </span>
                  </div>
                </th>
                <th class="relative px-6 py-3"><span class="sr-only">{{ t.actions }}</span></th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <tr v-for="repair in sortedAndFilteredRepairs" :key="repair.id" :class="{ 'table-row-selected': selectedRepairs.includes(repair.id), 'table-row-urgent': isUrgent(repair) }">
                <td class="px-6 py-4"><input type="checkbox" v-model="selectedRepairs" :value="repair.id" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm" v-html="highlight(repair.house)"></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm" v-html="highlight(repair.captured_at)"></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm" v-html="highlight(repair.fiche)"></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-medium" v-html="highlight(repair.error)"></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm" v-html="highlight(repair.ipei)"></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                  <span :class="getStatusClass(repair.status)" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" v-html="highlight(t[getStatusTranslationKey(repair.status)])"></span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm" v-html="highlight(repair.techniker || '---')"></td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button @click="editRepair(repair)" class="text-indigo-600 hover:text-indigo-900 ml-4 inline-block align-middle">{{ t.editButton }}</button>
                    <button @click="confirmDelete('repair', repair)" class="text-red-600 hover:text-red-900 ml-4 inline-block align-middle">{{ t.deleteButton }}</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Dashboard View -->
    <div v-if="currentView === 'dashboard'">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Stat Cards -->
            <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">{{ t.totalRepairs }}</p>
                    <p class="text-3xl font-bold text-gray-800">{{ totalRepairs }}</p>
                </div>
                <div class="bg-indigo-100 p-3 rounded-full"><svg class="h-6 w-6 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg></div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">{{ t.openCases }}</p>
                    <p class="text-3xl font-bold text-red-500">{{ openRepairs }}</p>
                </div>
                <div class="bg-red-100 p-3 rounded-full"><svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
            </div>
             <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">{{ t.statusCompleted }}</p>
                    <p class="text-3xl font-bold text-green-500">{{ totalRepairs - openRepairs }}</p>
                </div>
                <div class="bg-green-100 p-3 rounded-full"><svg class="h-6 w-6 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
            <!-- Reparaturen pro Haus -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold mb-4">{{ t.casesPerHouse }}</h3>
                <div class="space-y-3">
                    <div v-for="(count, house) in repairsByHouse" :key="house">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-medium">{{ house }}</span>
                            <span class="text-sm font-bold">{{ count }}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-indigo-600 h-2.5 rounded-full" :style="{ width: (count / maxRepairsInStats * 100) + '%' }"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top 5 Fehler -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold mb-4">{{ t.mostCommonErrors }}</h3>
                <ul class="space-y-2">
                    <li v-for="error in mostCommonErrors" :key="error.name" class="flex justify-between items-center text-sm">
                        <span class="text-gray-700 truncate pr-4">{{ error.name }}</span>
                        <span class="font-semibold bg-gray-100 px-2 py-1 rounded-md">{{ error.count }}x</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

  </div>

  <!-- Edit Modal -->
  <div v-if="showEditModal" class="modal-backdrop">
    <div class="modal-content">
      <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">{{ t.editEntry }}</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium text-gray-700">{{ t.houseLabel }}</label><select v-model="currentEdit.house" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"><option v-for="house in houses" :key="house" :value="house">{{ house }}</option></select></div>
        <div><label class="block text-sm font-medium text-gray-700">{{ t.capturedAtLabel }}</label><input v-model="currentEdit.captured_at" type="date" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div>
        <div><label class="block text-sm font-medium text-gray-700">{{ t.dateLabel }}</label><input v-model="currentEdit.date" type="text" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div>
        <div><label class="block text-sm font-medium text-gray-700">{{ t.deviceLabel }}</label><input v-model="currentEdit.fiche" type="text" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div>
        <div><label class="block text-sm font-medium text-gray-700">{{ t.engagementLabel }}</label><input v-model="currentEdit.fiche_engagement" type="text" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div>
        <div>
            <label class="block text-sm font-medium text-gray-700">{{ t.ipeiLabel }}</label>
            <div class="relative mt-1">
                <input v-model.trim="currentEdit.ipei" type="text" class="block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm pr-20">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                    <div v-if="isCheckingIpei" class="spinner h-5 w-5 border-2"></div>
                    <span v-else-if="ipeiHistoryCount > 0" class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800" :title="t.ipeiHistoryTooltip(ipeiHistoryCount)">
                        {{ ipeiHistoryCount }}x {{ t.ipeiHistoryFound }}
                    </span>
                </div>
            </div>
        </div>
        <div><label class="block text-sm font-medium text-gray-700">{{ t.pidLabel }}</label><input v-model="currentEdit.pid" type="text" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div>
        <div><label class="block text-sm font-medium text-gray-700">{{ t.errorLabel }}</label><input v-model="currentEdit.error" type="text" list="common-errors" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div>
        <div><label class="block text-sm font-medium text-gray-700">{{ t.statusLabel }}</label><select v-model="currentEdit.status" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"><option>{{ t.statusOpen }}</option><option>{{ t.statusInProgress }}</option><option>{{ t.statusCompleted }}</option><option>{{ t.statusCompletedAtCustomer }}</option></select></div>
        <div><label class="block text-sm font-medium text-gray-700">{{ t.assignTechnicianLabel }}</label><select v-model="currentEdit.techniker" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"><option value="">{{ t.noOne }}</option><option v-for="techniker in technikerList" :key="techniker" :value="techniker">{{ techniker }}</option></select></div>
      </div>
      <hr class="my-6">
      <div class="mt-4">
        <h4 class="text-md font-semibold text-gray-800 mb-2">{{ t.commentHistory }}</h4>
        <div class="bg-gray-50 p-3 rounded-md max-h-48 overflow-y-auto mb-3 space-y-3">
          <div v-for="comment in sortedComments(currentEdit.comments)" :key="comment.timestamp">
            <p :class="{'system-comment': comment.isSystem}" class="text-sm text-gray-700">{{ comment.text }}</p>
            <p class="text-xs text-gray-500 text-right">- {{ comment.user }} am {{ formatTimestamp(comment.timestamp) }}</p>
          </div>
          <p v-if="!currentEdit.comments || currentEdit.comments.length === 0" class="text-sm text-gray-500">{{ t.noCommentsYet }}</p>
        </div>
        <textarea v-model="newCommentText" rows="2" :placeholder="t.addCommentPlaceholder" class="block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
        <button @click="addComment" class="mt-2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md text-sm">{{ t.addCommentButton }}</button>
      </div>
      <div class="mt-6 flex justify-between">
        <button @click="exportPDF(currentEdit)" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md">{{ t.exportPdfButton }}</button>
        <div class="space-x-3">
          <button @click="showEditModal = false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md">{{ t.cancelButton }}</button>
          <button @click="saveEdit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">{{ t.saveButton }}</button>
        </div>
      </div>
    </div>
  </div>

  <!-- House Management Modal -->
  <div v-if="showHouseManagement" class="modal-backdrop">
    <div class="modal-content">
      <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">{{ t.manageHouses }}</h3>
      <div class="mb-4">
        <input v-model="newHouseName" @keyup.enter="addHouse" type="text" :placeholder="t.newHouseNamePlaceholder" class="p-2 border rounded w-full">
        <button @click="addHouse" class="mt-2 bg-indigo-600 text-white py-2 px-4 rounded hover:bg-indigo-700">{{ t.addButton }}</button>
      </div>
      <ul><li v-for="house in houses" :key="house" class="flex justify-between items-center p-2 border-b"><span>{{ house }}</span><button @click="confirmDelete('house', house)" class="text-red-500 hover:text-red-700 text-sm">{{ t.deleteButton }}</button></li></ul>
      <div class="mt-6 flex justify-end"><button @click="showHouseManagement = false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md">{{ t.closeButton }}</button></div>
    </div>
  </div>
  
  <!-- Techniker Management Modal -->
  <div v-if="showTechnikerManagement" class="modal-backdrop">
    <div class="modal-content">
      <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">{{ t.manageTechnicians }}</h3>
      <div class="mb-4">
        <input v-model="newTechnicianName" @keyup.enter="addTechnician" type="text" :placeholder="t.newTechnicianNamePlaceholder" class="p-2 border rounded w-full">
        <button @click="addTechnician" class="mt-2 bg-indigo-600 text-white py-2 px-4 rounded hover:bg-indigo-700">{{ t.addButton }}</button>
      </div>
      <ul><li v-for="techniker in technikerList" :key="techniker" class="flex justify-between items-center p-2 border-b"><span>{{ techniker }}</span><button @click="confirmDelete('technician', techniker)" class="text-red-500 hover:text-red-700 text-sm">{{ t.deleteButton }}</button></li></ul>
      <div class="mt-6 flex justify-end"><button @click="showTechnikerManagement = false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md">{{ t.closeButton }}</button></div>
    </div>
  </div>
    
  <!-- Fehler Management Modal -->
  <div v-if="showFehlerManagement" class="modal-backdrop">
    <div class="modal-content">
      <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">{{ t.manageErrors }}</h3>
      <div class="mb-4">
        <input v-model="newCommonError" @keyup.enter="addCommonError" type="text" :placeholder="t.newErrorPlaceholder" class="p-2 border rounded w-full">
        <button @click="addCommonError" class="mt-2 bg-indigo-600 text-white py-2 px-4 rounded hover:bg-indigo-700">{{ t.addButton }}</button>
      </div>
      <ul><li v-for="error in commonErrors" :key="error" class="flex justify-between items-center p-2 border-b"><span>{{ error }}</span><button @click="confirmDelete('commonError', error)" class="text-red-500 hover:text-red-700 text-sm">{{ t.deleteButton }}</button></li></ul>
      <div class="mt-6 flex justify-end"><button @click="showFehlerManagement = false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md">{{ t.closeButton }}</button></div>
    </div>
  </div>


    <!-- QR Code Management Modal -->
    <div v-if="showQrCodeManagement" class="modal-backdrop">
        <div class="modal-content">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">{{ t.manageQrCodes }}</h3>

            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                <p class="font-bold">{{ t.qrManagementTitle }}</p>
                <p class="text-sm mt-1">{{ t.qrManagementInfo }}</p>
            </div>

            <!-- Pattern Form -->
            <div class="p-4 border rounded-md mb-6">
                <h4 class="font-semibold mb-2">{{ currentPattern.id ? t.editPatternTitle : t.newPatternTitle }}</h4>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">{{ t.patternNameLabel }}</label>
                        <input v-model="currentPattern.name" type="text" :placeholder="t.patternNamePlaceholder" class="mt-1 p-2 border rounded w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">{{ t.exampleQrLabel }}</label>
                        <textarea v-model="currentPattern.example" @input="updatePreview" rows="3" :placeholder="t.exampleQrPlaceholder" class="mt-1 p-2 border rounded w-full font-mono"></textarea>
                    </div>

                    <!-- Fields -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div v-for="field in qrFields" :key="field.key">
                            <label class="block text-sm font-medium text-gray-700">{{ field.label }}</label>
                            <input v-model="currentPattern.parts[field.key]" @input="updatePreview" type="text" :placeholder="field.placeholder" class="mt-1 p-2 border rounded w-full font-mono">
                        </div>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700">{{ t.deviceNameLabel }}</label>
                        <input v-model="currentPattern.deviceName" @input="updatePreview" type="text" :placeholder="t.deviceNamePlaceholder" class="mt-1 p-2 border rounded w-full">
                    </div>

                    <!-- Preview -->
                    <div v-if="qrPreview.fiche">
                        <h5 class="font-semibold text-sm mb-2">{{ t.previewTitle }}</h5>
                        <div class="bg-gray-50 p-3 rounded-md text-sm space-y-1">
                            <p v-for="(value, key) in qrPreview" :key="key">
                                <span class="font-semibold">{{ t.qrFields[key] }}:</span>
                                <span class="ml-2 font-mono bg-gray-200 px-1 rounded">{{ value }}</span>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="mt-4 space-x-2">
                    <button @click="savePattern" class="bg-indigo-600 text-white py-2 px-4 rounded hover:bg-indigo-700 text-sm">{{ t.savePatternButton }}</button>
                    <button v-if="currentPattern.id" @click="resetPatternForm" class="bg-gray-200 text-gray-800 py-2 px-4 rounded hover:bg-gray-300 text-sm">{{ t.cancelEditButton }}</button>
                </div>
            </div>

            <!-- Existing Patterns List -->
            <div>
                <h4 class="font-semibold mb-2">{{ t.existingPatternsTitle }}</h4>
                <ul class="max-h-60 overflow-y-auto border rounded-md divide-y">
                    <li v-for="pattern in qrCodePatterns" :key="pattern.id" class="p-3 flex justify-between items-center">
                        <div>
                            <p class="font-semibold">{{ pattern.name }}</p>
                            <p class="text-xs text-gray-500 font-mono">{{ (pattern.example || '').substring(0, 50) }}...</p>
                        </div>
                        <div class="space-x-2">
                            <button @click="editPattern(pattern)" class="text-indigo-600 hover:text-indigo-800 text-sm">{{ t.editButton }}</button>
                            <button @click="confirmDelete('qrPattern', pattern)" class="text-red-500 hover:text-red-700 text-sm">{{ t.deleteButton }}</button>
                        </div>
                    </li>
                     <li v-if="qrCodePatterns.length === 0" class="p-3 text-sm text-gray-500">{{ t.noPatternsInfo }}</li>
                </ul>
            </div>

            <div class="mt-6 flex justify-end">
                <button @click="showQrCodeManagement = false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md">{{ t.closeButton }}</button>
            </div>
        </div>
    </div>
  
  <!-- Confirmation Modal -->
  <div v-if="showConfirmModal" class="modal-backdrop">
    <div class="modal-content max-w-sm">
        <h3 class="text-lg font-medium text-gray-900">{{ t.confirmAction }}</h3>
        <p class="mt-2 text-sm text-gray-600">{{ confirmMessage }}</p>
        <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
            <button @click="executeConfirm" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:col-start-2 sm:text-sm">
                {{ t.deleteButton }}
            </button>
            <button @click="cancelConfirm" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:col-start-1 sm:text-sm">
                {{ t.cancelButton }}
            </button>
        </div>
    </div>
  </div>

  <!-- Email Generation Modal -->
  <div v-if="showEmailModal" class="modal-backdrop">
    <div class="modal-content">
      <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">{{ t.emailGenerationTitle }}</h3>
      <p class="text-sm text-gray-600 mb-4">{{ t.emailGenerationInfo }}</p>
      <textarea readonly class="w-full h-64 p-2 border rounded font-mono text-sm bg-gray-50">{{ generatedEmailContent }}</textarea>
      <div class="mt-6 flex justify-between">
        <button @click="copyToClipboard(generatedEmailContent)" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">{{ t.copyTextButton }}</button>
        <button @click="showEmailModal = false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md">{{ t.closeButton }}</button>
      </div>
    </div>
  </div>


  <!-- Toast Notifications Container -->
  <div class="toast-container">
      <div v-for="toast in notifications" :key="toast.id" :class="['toast', toast.type, { 'show': toast.show }]">
          {{ toast.message }}
      </div>
  </div>

</div>

<!-- App Script -->
<script type="module">
  // --- Globale FehlerfÃ¤nger (gegen weiÃŸe Seite) ---
  window.addEventListener("error", e => {
    const box = document.getElementById("fatal");
    const msg = document.getElementById("fatal-msg");
    if (box && msg) { msg.textContent = (e && e.error && e.error.message) ? e.error.message : (e && e.message ? e.message : String(e)); box.style.display = "block"; }
    console.error("Uncaught error:", (e && e.error) ? e.error : e);
  });
  window.addEventListener("unhandledrejection", e => {
    const box = document.getElementById("fatal");
    const msg = document.getElementById("fatal-msg");
    if (box && msg) { msg.textContent = (e && e.reason && e.reason.message) ? e.reason.message : String(e && e.reason ? e.reason : e); box.style.display = "block"; }
    console.error("Unhandled promise rejection:", (e && e.reason) ? e.reason : e);
  });

  // Firebase SDKs
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
  import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, updateDoc, serverTimestamp, query, getDocs, setDoc, orderBy, where, enableIndexedDbPersistence, writeBatch } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
  
  // Vue 3
  import { createApp } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBR7PVIb3QaN6aI1VjJ27lIUhZm8c5R6_o",
    authDomain: "reparatur-manager-ells.firebaseapp.com",
    projectId: "reparatur-manager-ells",
    storageBucket: "reparatur-manager-ells.appspot.com",
    messagingSenderId: "666980467728",
    appId: "1:666980467728:web:7f97069b37b0a84966f695"
  };

  const firebaseApp = initializeApp(firebaseConfig);
  const auth = getAuth(firebaseApp);
  const db = getFirestore(firebaseApp);
  
  // Enable Firestore offline persistence only on mobile devices
  const isMobileDevice = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  if (isMobileDevice) {
    enableIndexedDbPersistence(db)
      .catch((err) => {
          if (err.code == 'failed-precondition') console.warn("Firestore persistence failed: Multiple tabs open.");
          else if (err.code == 'unimplemented') console.warn("Firestore persistence not available in this browser.");
      });
  }
  
  const appConfig = {
    data() {
      return {
        version: '1.58',
        isAuthReady: false,
        user: { loggedIn: false, email: null, uid: null, isAdmin: false, technicianName: null },
        loginForm: { email: '', password: '', error: '' },
        
        currentView: 'repairs',
        showAdminMenu: false,

        repairs: [],
        houses: [],
        technikerList: [],
        userList: [],
        commonErrors: [],
        newEntry: { house: '', captured_at: new Date().toISOString().slice(0,10), date: '', fiche: '', fiche_engagement: '', ipei: '', pid: '', error: '', status: 'Offen', comments: [], techniker: '' },
        
        qrCodeInput: '',
        qrScanTimer: null,
        ipeiCheckTimer: null,
        isCheckingIpei: false,
        ipeiHistoryCount: 0,
        filter: { house: '', search: '', technician: '', status: '' },
        sortKey: 'createdAt',
        sortOrder: 'desc',
        
        showEditModal: false,
        showEmailModal: false,
        generatedEmailContent: '',
        currentEdit: {},
        originalEdit: {}, // FÃ¼r Audit Trail
        newCommentText: '',
        
        showHouseManagement: false,
        showTechnikerManagement: false,
        showFehlerManagement: false,
        showQrCodeManagement: false,
        showUserManagement: false,

        newHouseName: '',
        newTechnicianName: '',
        newCommonError: '',
        newUser: { email: '', isAdmin: false, technicianName: ''},
        
        qrCodePatterns: [],
        qrFields: [
            { key: 'fiche', label: 'GerÃ¤t-Code', placeholder: 'Teilstring fÃ¼r GerÃ¤t...' },
            { key: 'date', label: 'Datum', placeholder: 'Teilstring fÃ¼r Datum...' },
            { key: 'ipei', label: 'IPEI', placeholder: 'Teilstring fÃ¼r IPEI...' },
            { key: 'pid', label: 'P-ID', placeholder: 'Teilstring fÃ¼r P-ID...' }
        ],
        currentPattern: { id: null, name: '', example: '', deviceName: '', parts: { fiche: '', date: '', ipei: '', pid: '' } },
        qrPreview: {},

        selectedRepairs: [],
        bulkEdit: { technician: '', status: '' },

        showConfirmModal: false,
        confirmMessage: '',
        confirmAction: null,

        notifications: [],
        
        // Dashboard
        allRepairsForStats: [],

        // Internationalization (i18n)
        currentLanguage: 'de',
        isOnline: navigator.onLine,
        isFullscreen: false,
        translations: {
            de: {
                mainTitle: "Reparatur Manager",
                repairs: "Reparaturen",
                myRepairs: "Meine Reparaturen",
                dashboard: "Dashboard",
                administration: "Verwaltung",
                users: "Benutzer",
                technicians: "Techniker",
                manageHouses: "HÃ¤user verwalten",
                manageErrors: "Fehler verwalten",
                manageQrCodes: "GerÃ¤te & QR-Codes verwalten",
                loggedInAs: "Angemeldet als",
                newRepairEntry: "Neuer Reparatur-Eintrag",
                houseLabel: "Haus",
                capturedAtLabel: "Erfasst am",
                dateLabel: "Datum",
                deviceLabel: "GerÃ¤t",
                engagementLabel: "Fiche d'engagement",
                ipeiLabel: "IPEI",
                pidLabel: "P-ID",
                errorLabel: "Fehler",
                statusLabel: "Status",
                assignTechnicianLabel: "Techniker zuweisen",
                qrCodeLabel: "Barcode / QR-Code",
                scanPlaceholder: "Hier scannen oder einfÃ¼gen...",
                addButton: "HinzufÃ¼gen",
                houseFilterLabel: "Haus:",
                technicianFilterLabel: "Techniker:",
                statusFilterLabel: "Status:",
                all: "Alle",
                searchLabel: "Suche:",
                searchPlaceholder: "Suchen...",
                tableHeaders: { house: 'Haus', captured_at: 'Erfasst am', fiche: 'GerÃ¤t', error: 'Fehler', ipei: 'IPEI', status: 'Status', techniker: 'Techniker' },
                actions: "Aktionen",
                editButton: "Bearbeiten",
                deleteButton: "LÃ¶schen",
                statusOpen: "Offen",
                statusInProgress: "In Bearbeitung",
                statusCompleted: "Abgeschlossen",
                statusCompletedAtCustomer: "Beim Kunden repariert",
                noOne: "Niemand",
                totalRepairs: "Gesamte Reparaturen",
                openCases: "Offene FÃ¤lle",
                casesPerHouse: "FÃ¤lle pro Haus",
                mostCommonErrors: "HÃ¤ufigste Fehler (Top 5)",
                editEntry: "Eintrag bearbeiten",
                commentHistory: "Historie & Kommentare",
                noCommentsYet: "Noch keine Kommentare.",
                addCommentPlaceholder: "Neuen Kommentar hinzufÃ¼gen...",
                addCommentButton: "Kommentar hinzufÃ¼gen",
                cancelButton: "Abbrechen",
                saveButton: "Speichern",
                exportPdfButton: "PDF Exportieren",
                closeButton: "SchlieÃŸen",
                newHouseNamePlaceholder: "Neuen Hausnamen eingeben",
                newErrorPlaceholder: "Neuen Fehlertext eingeben",
                manageTechnicians: "Techniker verwalten",
                newTechnicianNamePlaceholder: "Neuen Techniker eingeben",
                confirmAction: "Aktion bestÃ¤tigen",
                notifRepairAdded: "Reparatur erfolgreich hinzugefÃ¼gt.",
                notifConfirmDelete: (item) => `MÃ¶chten Sie den Reparatureintrag fÃ¼r "${item}" wirklich lÃ¶schen?`,
                notifHousesLoading: 'HÃ¤user werden noch geladen, bitte warten.',
                notifFillHouseAndDevice: 'Bitte Haus und GerÃ¤t ausfÃ¼llen.',
                notifUnsavedComment: 'Sie haben einen Kommentar geschrieben, aber nicht hinzugefÃ¼gt. Bitte klicken Sie zuerst auf "Kommentar hinzufÃ¼gen".',
                notifChangesSaved: 'Ã„nderungen gespeichert.',
                notifEntryDeleted: 'Eintrag gelÃ¶scht.',
                notifDeleteError: 'Fehler: Eintrag konnte nicht gelÃ¶scht werden.',
                notifQrSuccess: 'Code erfolgreich verarbeitet!',
                notifQrError: 'Code konnte keinem Muster zugeordnet werden.',
                notifCommentEmpty: 'Kommentar darf nicht leer sein.',
                notifNowOnline: 'Sie sind wieder online. Daten werden synchronisiert.',
                notifNowOffline: 'Sie sind jetzt offline. Ã„nderungen werden lokal gespeichert.',
                enterFullscreen: "Vollbildmodus",
                exitFullscreen: "Vollbildmodus beenden",
                qrManagementTitle: "So funktioniert's:",
                qrManagementInfo: "FÃ¼gen Sie ein Beispiel eines echten Codes ein. Markieren Sie dann die Teile des Codes, die den jeweiligen Feldern entsprechen. Das System lernt daraus ein Muster fÃ¼r die zukÃ¼nftige Erkennung.",
                newPatternTitle: "Neues Code-Muster erstellen",
                editPatternTitle: "Code-Muster bearbeiten",
                patternNameLabel: "Name des Musters",
                patternNamePlaceholder: "z.B. 'Lange Etikette V1'",
                exampleQrLabel: "Beispiel-Code",
                exampleQrPlaceholder: "Hier den kompletten Inhalt eines echten Codes einfÃ¼gen...",
                deviceNameLabel: "VollstÃ¤ndiger GerÃ¤tename (optional)",
                deviceNamePlaceholder: "z.B. 'CH-7722 TIPTEL'",
                previewTitle: "Vorschau der erkannten Daten:",
                qrFields: { fiche: 'GerÃ¤t', date: 'Datum', ipei: 'IPEI', pid: 'P-ID', deviceName: 'GerÃ¤tename' },
                savePatternButton: "Muster speichern",
                cancelEditButton: "Bearbeitung abbrechen",
                existingPatternsTitle: "Gespeicherte Muster",
                noPatternsInfo: "Noch keine Muster erstellt.",
                bulkEditSelected: "EintrÃ¤ge ausgewÃ¤hlt.",
                bulkEditAssignTechnician: "Techniker zuweisen:",
                bulkEditChangeStatus: "Status Ã¤ndern:",
                bulkEditApplyButton: "Anwenden",
                noChange: "Keine Ã„nderung",
                notifBulkUpdateSuccess: (count) => `${count} EintrÃ¤ge erfolgreich aktualisiert.`,
                notifBulkUpdateError: "Fehler bei der Massenbearbeitung.",
                ipeiHistoryFound: "gesehen",
                ipeiHistoryTooltip: (count) => `Diese IPEI wurde bereits in ${count} anderen EintrÃ¤gen gefunden.`,
                generateEmailButton: "E-Mail generieren",
                emailGenerationTitle: "E-Mail Inhalt generieren",
                emailGenerationInfo: "Der folgende Text wurde generiert. Kopieren Sie ihn und fÃ¼gen Sie ihn in Ihr E-Mail-Programm ein.",
                copyTextButton: "Text kopieren",
                copySuccess: "Text in die Zwischenablage kopiert!",
                copyError: "Fehler beim Kopieren.",
                emailGreeting: "Guten Tag,",
                emailClosing: "Freundliche GrÃ¼sse",
                loginButton: "Anmelden",
                logoutButton: "Abmelden",
                emailPlaceholder: "E-Mail-Adresse",
                passwordPlaceholder: "Passwort",
                loginError: "E-Mail oder Passwort ist falsch."
            },
            fr: { /* ... */ }
        }
      }
    },
    watch: {
      qrCodeInput(newValue){
        if(this.qrScanTimer) clearTimeout(this.qrScanTimer);
        if(newValue){ 
            this.qrScanTimer = setTimeout(()=>{ 
                if (this.qrCodeInput === newValue) {
                    this.processQRCode(newValue); 
                }
            }, 500);
        }
      },
      'newEntry.ipei'(newValue) {
        if (this.ipeiCheckTimer) clearTimeout(this.ipeiCheckTimer);
        this.ipeiHistoryCount = 0;
        const trimmedValue = newValue ? newValue.trim() : '';
        if (trimmedValue && trimmedValue.length > 5) {
            this.isCheckingIpei = true;
            this.ipeiCheckTimer = setTimeout(() => {
                this.checkIpeiHistory(trimmedValue);
            }, 500);
        } else {
            this.isCheckingIpei = false;
        }
      },
      'currentEdit.ipei'(newValue) {
          if(!this.showEditModal) return;
          if (this.ipeiCheckTimer) clearTimeout(this.ipeiCheckTimer);
          this.ipeiHistoryCount = 0;
          const trimmedValue = newValue ? newValue.trim() : '';
          if (trimmedValue && trimmedValue.length > 5) {
              this.isCheckingIpei = true;
              this.ipeiCheckTimer = setTimeout(() => {
                  this.checkIpeiHistory(trimmedValue, this.currentEdit.id);
              }, 500);
          } else {
              this.isCheckingIpei = false;
          }
      },
      currentView(newView) {
        if (newView === 'dashboard' && this.allRepairsForStats.length === 0) {
            this.loadAllRepairsForStats();
        }
      },
      isOnline(newStatus) {
        if (newStatus) this.showNotification(this.t.notifNowOnline, 'success');
        else this.showNotification(this.t.notifNowOffline, 'info');
      }
    },
    computed: {
      t() { return this.translations[this.currentLanguage]; },
      tableHeaders() { return this.t.tableHeaders; },
      sortedAndFilteredRepairs() {
        let filtered = this.repairs;
        if (this.currentView === 'my_repairs' && this.user.technicianName) {
            filtered = filtered.filter(r => r.techniker === this.user.technicianName);
        }
        if (this.filter.house) filtered = filtered.filter(r => r.house === this.filter.house);
        if (this.currentView !== 'my_repairs' && this.filter.technician) {
            filtered = filtered.filter(r => r.techniker === this.filter.technician);
        }
        if (this.filter.status) filtered = filtered.filter(r => r.status === this.filter.status);

        if (this.filter.search) {
          const s = this.filter.search.toLowerCase();
          filtered = filtered.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(s)));
        }
        if (this.sortKey) {
          const sorted = [...filtered];
          sorted.sort((a, b) => {
            let valA = a[this.sortKey];
            let valB = b[this.sortKey];
            if (valA === undefined || valA === null) valA = '';
            if (valB === undefined || valB === null) valB = '';
            if (valA && typeof valA.toDate === 'function') valA = valA.toDate().getTime();
            if (valB && typeof valB.toDate === 'function') valB = valB.toDate().getTime();
            if (typeof valA === 'string') valA = valA.toLowerCase();
            if (typeof valB === 'string') valB = valB.toLowerCase();
            if (valA < valB) return this.sortOrder === 'asc' ? -1 : 1;
            if (valA > valB) return this.sortOrder === 'asc' ? 1 : -1;
            return 0;
          });
          return sorted;
        }
        return filtered;
      },
      allSelected(){
        const displayedIds = this.sortedAndFilteredRepairs.map(r => r.id);
        return displayedIds.length > 0 && displayedIds.every(id => this.selectedRepairs.includes(id));
      },
      totalRepairs() { return this.allRepairsForStats.length; },
      openRepairs() { return this.allRepairsForStats.filter(r => r.status === 'Offen' || r.status === 'In Bearbeitung').length; },
      repairsByHouse() {
          const counts = this.allRepairsForStats.reduce((acc, repair) => {
              acc[repair.house] = (acc[repair.house] || 0) + 1;
              return acc;
          }, {});
          return Object.fromEntries(Object.entries(counts).sort(([,a],[,b]) => b-a));
      },
      mostCommonErrors() {
          const allErrors = this.allRepairsForStats.map(r => r.error).filter(e => e);
          const customErrors = this.commonErrors;
          const combined = [...allErrors, ...customErrors];

          const counts = combined.reduce((acc, error) => {
              if (error) {
                  const errorKey = error.trim().toLowerCase();
                  acc[errorKey] = (acc[errorKey] || 0) + 1;
              }
              return acc;
          }, {});
          return Object.entries(counts).sort(([,a],[,b]) => b-a).slice(0, 5).map(([name, count]) => ({name: this.capitalizeFirstLetter(name), count}));
      },
      maxRepairsInStats() { return Math.max(...Object.values(this.repairsByHouse), 1); }
    },
    methods: {
      highlight(text) {
        const search = this.filter.search;
        if (!search) return text;
        const searchTerm = search.trim();
        if (!searchTerm) return text;
        const escapedSearchTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');
        return String(text).replace(regex, '<mark>$1</mark>');
      },
      isUrgent(repair) {
        if (!repair || !repair.status || !repair.captured_at) return false;
        if (repair.status !== 'Offen') return false;
        const capturedDate = new Date(repair.captured_at);
        const today = new Date();
        const diffTime = Math.abs(today - capturedDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays > 14;
      },
      setLanguage(lang) { this.currentLanguage = lang; document.documentElement.lang = lang; },
      getStatusTranslationKey(status) {
        const statusMap = { 'Offen': 'statusOpen', 'In Bearbeitung': 'statusInProgress', 'Abgeschlossen': 'statusCompleted', 'Beim Kunden repariert': 'statusCompletedAtCustomer' };
        return statusMap[status] || status;
      },
      showNotification(message, type = 'info', duration = 3000) {
          const id = Date.now() + Math.random();
          const notification = { id, message, type: `toast-${type}`, show: false };
          this.notifications.push(notification);
          this.$nextTick(() => {
              const toast = this.notifications.find(n => n.id === id);
              if (toast) toast.show = true;
          });
          setTimeout(() => {
              const toast = this.notifications.find(n => n.id === id);
              if (toast) toast.show = false;
              setTimeout(() => { this.notifications = this.notifications.filter(n => n.id !== id); }, 300);
          }, duration);
      },
      getStatusClass(status) {
        switch (status) {
            case 'Abgeschlossen': case 'Beim Kunden repariert': return 'bg-green-100 text-green-800';
            case 'In Bearbeitung': return 'bg-blue-100 text-blue-800';
            case 'Offen': return 'bg-red-100 text-red-800';
            default: return 'bg-gray-100 text-gray-800';
        }
      },
      confirmDelete(type, item) {
          if (type === 'repair') {
              this.confirmMessage = this.t.notifConfirmDelete(item.fiche || 'Unbekannt');
              this.confirmAction = () => this.deleteRepair(item.id);
          } else if (type === 'house') {
              this.confirmMessage = `Haus "${item}" wirklich lÃ¶schen?`;
              this.confirmAction = () => this.deleteHouse(item);
          } else if (type === 'technician') {
              this.confirmMessage = `Techniker "${item}" wirklich lÃ¶schen?`;
              this.confirmAction = () => this.deleteTechnician(item);
          } else if (type === 'commonError') {
              this.confirmMessage = `Fehler "${item}" wirklich lÃ¶schen?`;
              this.confirmAction = () => this.deleteCommonError(item);
          } else if (type === 'qrPattern') {
              this.confirmMessage = `QR-Muster "${item.name}" wirklich lÃ¶schen?`;
              this.confirmAction = () => this.deletePattern(item.id);
          }
          this.showConfirmModal = true;
      },
      executeConfirm() { if (typeof this.confirmAction === 'function') this.confirmAction(); this.cancelConfirm(); },
      cancelConfirm() { this.showConfirmModal = false; this.confirmMessage = ''; this.confirmAction = null; },
      async addRepair(){
        if (this.houses.length === 0) { this.showNotification(this.t.notifHousesLoading, 'error'); return; }
        if(!this.newEntry.house || !this.newEntry.fiche){ this.showNotification(this.t.notifFillHouseAndDevice, 'error'); return; }
        const lastSelectedHouse = this.newEntry.house;
        const dataToSave = JSON.parse(JSON.stringify(this.newEntry));
        await addDoc(collection(db,'repairs'), { ...dataToSave, cost:0, createdAt: serverTimestamp() });
        Object.assign(this.newEntry, { captured_at:new Date().toISOString().slice(0,10), date:'', fiche:'', fiche_engagement:'', ipei:'', pid:'', error:'', status:'Offen', comments: [], techniker: '' });
        this.newEntry.house = lastSelectedHouse;
        this.showNotification(this.t.notifRepairAdded, 'success');
      },
      editRepair(r){ 
        this.ipeiHistoryCount = 0; // Reset history count
        this.currentEdit = JSON.parse(JSON.stringify(r));
        this.originalEdit = JSON.parse(JSON.stringify(r)); // FÃ¼r Audit Trail
        if (!this.currentEdit.comments) this.currentEdit.comments = [];
        if (!this.currentEdit.techniker) this.currentEdit.techniker = '';
        this.showEditModal = true; 
      },
      async saveEdit(){
        if (this.newCommentText.trim()) { this.showNotification(this.t.notifUnsavedComment, 'error', 5000); return; }
        
        const changes = [];
        const fieldsToTrack = { house: 'Haus', captured_at: 'Erfasst am', date: 'Datum', fiche: 'GerÃ¤t', error: 'Fehler', ipei: 'IPEI', pid: 'P-ID', status: 'Status', techniker: 'Techniker' };
        for (const key in fieldsToTrack) {
            const oldValue = (this.originalEdit[key] || '').toString();
            const newValue = (this.currentEdit[key] || '').toString();
            if(oldValue !== newValue) {
                changes.push(`${fieldsToTrack[key]} von '${oldValue || 'leer'}' auf '${newValue || 'leer'}' geÃ¤ndert.`);
            }
        }
        if(changes.length > 0) {
            if(!this.currentEdit.comments) this.currentEdit.comments = [];
            this.currentEdit.comments.push({ text: changes.join(' '), user: this.user.email, timestamp: Date.now(), isSystem: true });
        }

        const ref = doc(db,'repairs',this.currentEdit.id);
        const data = { ...JSON.parse(JSON.stringify(this.currentEdit)) }; 
        delete data.id;
        await updateDoc(ref, data);
        this.showEditModal = false;
        this.showNotification(this.t.notifChangesSaved, 'success');
      },
      async deleteRepair(repairId){
        try { await deleteDoc(doc(db, 'repairs', repairId)); this.showNotification(this.t.notifEntryDeleted, 'info'); }
        catch(error) { console.error("Error during deletion:", error); this.showNotification(this.t.notifDeleteError, 'error'); }
      },
      toggleSelectAll(e){
        const displayedIds = this.sortedAndFilteredRepairs.map(r => r.id);
        if (e.target.checked) this.selectedRepairs = [...new Set([...this.selectedRepairs, ...displayedIds])];
        else this.selectedRepairs = this.selectedRepairs.filter(id => !displayedIds.includes(id));
      },
      handleQrKeyDown(event) {
        if (event.ctrlKey && !['a', 'c', 'v', 'x'].includes(event.key.toLowerCase())) {
            event.preventDefault();
        }
      },
      processQRCode(text){
        const parsed = this.parseQRCodeData(text || '');
        if (parsed && Object.keys(parsed).length > 0) {
            Object.assign(this.newEntry, parsed);
            this.qrCodeInput = '';
            this.showNotification(this.t.notifQrSuccess, 'success');
        } else {
            this.qrCodeInput = text || '';
            this.showNotification(this.t.notifQrError, 'error');
        }
      },
      parseQRCodeData(text) {
        const cleanedText = String(text || '').replace(/[\x00-\x1F\x7F-\x9F]/g, "").replace(/\s+/g, ' ').trim();
        if (!cleanedText || this.qrCodePatterns.length === 0) return null;

        for (const pattern of this.qrCodePatterns) {
            if (!pattern.example || !pattern.parts) continue;
            const sortedParts = Object.entries(pattern.parts).filter(([, value]) => value).map(([key, value]) => ({ key, value, index: pattern.example.indexOf(value) })).filter(part => part.index !== -1).sort((a, b) => a.index - b.index);
            if (sortedParts.length === 0) continue;
            let tempText = cleanedText;
            const extractedData = {};
            let allPartsFound = true;
            for (let i = 0; i < sortedParts.length; i++) {
                const currentPart = sortedParts[i];
                const nextPart = sortedParts[i + 1];
                const startDelimiterIndex = (i === 0) ? 0 : pattern.example.indexOf(sortedParts[i-1].value) + sortedParts[i-1].value.length;
                const startDelimiter = pattern.example.substring(startDelimiterIndex, currentPart.index);
                const endDelimiterIndex = nextPart ? nextPart.index : pattern.example.length;
                const endDelimiter = pattern.example.substring(currentPart.index + currentPart.value.length, endDelimiterIndex);
                const startIndex = startDelimiter ? tempText.indexOf(startDelimiter) : 0;
                if (startIndex === -1) { allPartsFound = false; break; }
                const searchStart = startIndex + (startDelimiter ? startDelimiter.length : 0);
                const endIndex = endDelimiter ? tempText.indexOf(endDelimiter, searchStart) : -1;
                if (endIndex === -1 && endDelimiter) { allPartsFound = false; break; }
                extractedData[currentPart.key] = tempText.substring(searchStart, endIndex === -1 ? undefined : endIndex);
                tempText = tempText.substring(endIndex === -1 ? tempText.length : endIndex);
            }
            if (allPartsFound && Object.keys(extractedData).length > 0) {
                 if (pattern.deviceName) extractedData.fiche = pattern.deviceName;
                 return extractedData;
            }
        }
        return null;
      },
       async checkIpeiHistory(ipeiValue, currentIdToExclude = null) {
        if (!ipeiValue) {
          this.isCheckingIpei = false;
          return;
        }
        try {
          const q = query(collection(db, 'repairs'), where('ipei', '==', ipeiValue));
          const querySnapshot = await getDocs(q);
          
          let count = 0;
          querySnapshot.forEach(doc => {
              if (doc.id !== currentIdToExclude) {
                  count++;
              }
          });

          this.ipeiHistoryCount = count;

        } catch (error) {
          console.error("Error checking IPEI history:", error);
          this.showNotification("Fehler bei der IPEI-PrÃ¼fung.", 'error');
        } finally {
          this.isCheckingIpei = false;
        }
      },
      async addHouse(){
        if(this.newHouseName && !this.houses.includes(this.newHouseName)){
          try {
            await setDoc(doc(db,'config','houses'), { list: [...this.houses, this.newHouseName] });
            this.newHouseName='';
            this.showNotification('Haus erfolgreich hinzugefÃ¼gt.', 'success');
          } catch(e) { console.error(e); this.showNotification('Fehler beim Speichern des Hauses.', 'error'); }
        }
      },
      async deleteHouse(houseName){ await setDoc(doc(db,'config','houses'), { list: this.houses.filter(x=>x!==houseName) }); },
      async addTechnician(){
        if(this.newTechnicianName && !this.technikerList.includes(this.newTechnicianName)){
          try {
            await setDoc(doc(db,'config','technicians'), { list: [...this.technikerList, this.newTechnicianName] });
            this.newTechnicianName='';
            this.showNotification('Techniker erfolgreich hinzugefÃ¼gt.', 'success');
          } catch(e) { console.error(e); this.showNotification('Fehler beim Speichern des Technikers.', 'error'); }
        }
      },
      async deleteTechnician(technicianName){ await setDoc(doc(db,'config','technicians'), { list: this.technikerList.filter(x=>x!==technicianName) }); },
      async addCommonError(){
        if(this.newCommonError && !this.commonErrors.includes(this.newCommonError)){
          try {
            await setDoc(doc(db,'config','commonErrors'), { list: [...this.commonErrors, this.newCommonError] });
            this.newCommonError='';
            this.showNotification('Fehler erfolgreich hinzugefÃ¼gt.', 'success');
          } catch(e) { console.error(e); this.showNotification('Fehler beim Speichern.', 'error'); }
        }
      },
      async deleteCommonError(errorName){ await setDoc(doc(db,'config','commonErrors'), { list: this.commonErrors.filter(x=>x!==errorName) }); },
      resetPatternForm() { this.currentPattern = { id: null, name: '', example: '', deviceName: '', parts: { fiche: '', date: '', ipei: '', pid: '' } }; this.qrPreview = {}; },
      editPattern(pattern) { this.currentPattern = JSON.parse(JSON.stringify(pattern)); this.updatePreview(); },
      updatePreview() { const parsed = this.parseQRCodeData(this.currentPattern.example); this.qrPreview = parsed ? parsed : {}; },
      async savePattern() {
          let patterns = [...this.qrCodePatterns];
          if (this.currentPattern.id) {
              const index = patterns.findIndex(p => p.id === this.currentPattern.id);
              if (index !== -1) patterns[index] = this.currentPattern;
          } else patterns.push({ ...this.currentPattern, id: Date.now().toString() });
          await setDoc(doc(db, 'config', 'qrCodePatterns'), { patterns: patterns });
          this.resetPatternForm();
          this.showNotification('Muster gespeichert', 'success');
      },
      async deletePattern(patternId) {
          const updatedPatterns = this.qrCodePatterns.filter(p => p.id !== patternId);
          await setDoc(doc(db, 'config', 'qrCodePatterns'), { patterns: updatedPatterns });
          this.showNotification('Muster gelÃ¶scht', 'info');
      },
      addComment() {
          if (!this.newCommentText.trim()) { this.showNotification(this.t.notifCommentEmpty, 'error'); return; }
          if (!this.currentEdit.comments) this.currentEdit.comments = [];
          this.currentEdit.comments.push({ text: this.newCommentText, user: this.user.email, timestamp: Date.now(), isSystem: false });
          this.newCommentText = '';
      },
      formatTimestamp(ts) {
          if (!ts) return '';
          const date = ts.toDate ? ts.toDate() : new Date(ts);
          if (isNaN(date)) return '';
          return date.toLocaleString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
      },
      sortedComments(comments) {
        if (!comments) return [];
        return [...comments].sort((a,b) => a.timestamp - b.timestamp);
      },
      async applyBulkEdit() {
          if (this.selectedRepairs.length === 0) return;
          if (!this.bulkEdit.technician && !this.bulkEdit.status) return;

          const batch = writeBatch(db);
          const updates = {};
          if (this.bulkEdit.status) updates.status = this.bulkEdit.status;
          if (this.bulkEdit.technician) updates.techniker = this.bulkEdit.technician === 'NONE' ? '' : this.bulkEdit.technician;
          
          this.selectedRepairs.forEach(id => {
              const ref = doc(db, 'repairs', id);
              batch.update(ref, updates);
          });
          
          try {
            await batch.commit();
            this.showNotification(this.t.notifBulkUpdateSuccess(this.selectedRepairs.length), 'success');
            this.selectedRepairs = [];
            this.bulkEdit = { technician: '', status: '' };
          } catch(e) {
            console.error(e);
            this.showNotification(this.t.notifBulkUpdateError, 'error');
          }
      },
      generateEmail() {
        if (this.selectedRepairs.length === 0) return;
        let emailBody = `${this.t.emailGreeting}\n\n`;
        const repairsToInclude = this.repairs.filter(r => this.selectedRepairs.includes(r.id));
        for (const repair of repairsToInclude) {
            emailBody += `---------------------------------\n`;
            emailBody += `${this.t.houseLabel}: ${repair.house || '-'}\n`;
            emailBody += `${this.t.ipeiLabel}: ${repair.ipei || '-'}\n`;
            emailBody += `${this.t.capturedAtLabel}: ${repair.captured_at || '-'}\n`;
            emailBody += `${this.t.errorLabel}: ${repair.error || '-'}\n`;
        }
        emailBody += `---------------------------------\n\n`;
        emailBody += `${this.t.emailClosing}\n`;
        this.generatedEmailContent = emailBody;
        this.showEmailModal = true;
      },
      copyToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            this.showNotification(this.t.copySuccess, 'success');
        } catch (err) {
            this.showNotification(this.t.copyError, 'error');
        }
        document.body.removeChild(textArea);
      },
      exportPDF(repair) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(16);
        doc.text("Reparatur-Bericht", 105, 20, { align: 'center' });

        doc.setFont("helvetica", "normal");
        doc.setFontSize(11);
        const detailFields = [
            { label: 'GerÃ¤t', value: repair.fiche },
            { label: 'Erfasst am', value: repair.captured_at },
            { label: 'Haus', value: repair.house },
            { label: 'Status', value: repair.status },
            { label: 'Fehler', value: repair.error },
            { label: 'Techniker', value: repair.techniker },
            { label: 'IPEI', value: repair.ipei },
            { label: 'P-ID', value: repair.pid },
        ];
        
        const body = detailFields.filter(f => f.value).map(f => [f.label, f.value]);
        doc.autoTable({
          startY: 30,
          head: [['Feld', 'Wert']],
          body: body,
          theme: 'grid',
          headStyles: { fillColor: [79, 70, 229] },
        });

        if (repair.comments && repair.comments.length > 0) {
            const commentsBody = this.sortedComments(repair.comments).map(c => [
                this.formatTimestamp(c.timestamp),
                c.user,
                c.text
            ]);
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 10,
                head: [['Datum', 'Benutzer', 'Eintrag']],
                body: commentsBody,
                theme: 'striped',
                headStyles: { fillColor: [79, 70, 229] },
                didParseCell: function (data) {
                    const originalComment = repair.comments.find(c => c.text === data.cell.raw);
                    if(originalComment && originalComment.isSystem) {
                       data.cell.styles.fontStyle = 'italic';
                       data.cell.styles.textColor = '#555';
                    }
                }
            });
        }
        
        doc.save(`reparatur_${repair.fiche || 'unbekannt'}_${repair.captured_at}.pdf`);
      },
      listenToRepairs() {
          const q = query(collection(db, 'repairs'), orderBy('createdAt', 'desc'));
          onSnapshot(q, (snapshot) => { this.repairs = snapshot.docs.map(d => ({ id: d.id, ...d.data() })); },
          (error) => { console.error("Fehler beim Laden der Reparaturen:", error); });
      },
      async loadAllRepairsForStats() {
          const q = query(collection(db, 'repairs'), orderBy('createdAt', 'desc'));
          const querySnapshot = await getDocs(q);
          this.allRepairsForStats = querySnapshot.docs.map(d => d.data());
      },
      listenToConfig(docId, dataName, fieldName) {
          onSnapshot(doc(db, 'config', docId), (d) => {
              if (d.exists() && d.data() && d.data()[fieldName]) {
                  this[dataName] = d.data()[fieldName];
                  if (dataName === 'houses' && !this.newEntry.house && this.houses.length > 0) this.newEntry.house = this.houses[0];
              }
          });
      },
      capitalizeFirstLetter(string) { return string.charAt(0).toUpperCase() + string.slice(1); },
      toggleFullscreen() {
        if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(err => { console.error(`Vollbild-Fehler: ${err.message} (${err.name})`); });
        else if (document.exitFullscreen) document.exitFullscreen();
      },
      handleFullscreenChange() { this.isFullscreen = !!document.fullscreenElement; },
      sortBy(key) {
        if (this.sortKey === key) this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
        else { this.sortKey = key; this.sortOrder = 'asc'; }
      },
      exportCSV() {
            const headers = Object.values(this.tableHeaders);
            const keys = Object.keys(this.tableHeaders);
            const data = this.sortedAndFilteredRepairs.map(row => 
                keys.map(key => {
                    let val = row[key] || '';
                    if (typeof val === 'string') {
                        val = val.replace(/"/g, '""');
                        if (val.includes(',') || val.includes('\n')) val = `"${val}"`;
                    }
                    return val;
                }).join(',')
            );
            const csvContent = "\uFEFF" + headers.join(',') + "\n" + data.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `reparaturen_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link); 
            link.click();
            document.body.removeChild(link);
      },
      async login(){
        this.loginForm.error = '';
        try { 
          await signInWithEmailAndPassword(auth, this.loginForm.email, this.loginForm.password); 
        } catch(e){ 
          this.loginForm.error = this.t.loginError; 
          console.error(e); 
        }
      },
      async logout(){ await signOut(auth); },
    },
    async mounted(){
      window.addEventListener('online', () => this.isOnline = true);
      window.addEventListener('offline', () => this.isOnline = false);
      document.addEventListener('fullscreenchange', this.handleFullscreenChange);

      const authCheck = new Promise(resolve => {
        onAuthStateChanged(auth, async (u)=>{
          if(u){
            this.user = { loggedIn:true, email:u.email, uid:u.uid, isAdmin:false, technicianName: null };
            const userDocQuery = query(collection(db,'users'), where('email','==',u.email));
            const userDocSnap = await getDocs(userDocQuery);

            if(!userDocSnap.empty){
                const userData = userDocSnap.docs[0].data();
                this.user.isAdmin = userData.isAdmin || false;
                this.user.technicianName = userData.technicianName || null;
            }
            
            this.listenToRepairs();
            this.listenToConfig('houses', 'houses', 'list');
            this.listenToConfig('technicians', 'technikerList', 'list');
            if(this.user.isAdmin) {
                onSnapshot(collection(db,'users'), s => { this.userList = s.docs.map(d => ({ id:d.id, ...d.data() })); });
                this.listenToConfig('qrCodePatterns', 'qrCodePatterns', 'patterns');
                this.listenToConfig('commonErrors', 'commonErrors', 'list');
            }
          } else {
            this.user = { loggedIn:false, email:null, uid:null, isAdmin:false, technicianName: null };
            this.repairs = []; this.userList = []; this.houses = []; this.technikerList = [];
          }
          resolve();
        });
      });

      const minDelay = new Promise(resolve => setTimeout(resolve, 1500));
      await Promise.all([authCheck, minDelay]);
      this.isAuthReady = true;
    }
  };

  document.addEventListener('DOMContentLoaded', () => {
    createApp(appConfig).mount('#app');
  });

</script>
</body>
</html>

